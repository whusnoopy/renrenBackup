# 留言板

本来是打算先弄相册的，后面发现还有留言板，结构更简单，就先搞这个了

跟状态一样，第一页是直接渲染出来的，翻页的时候就看到 xhr 请求。这样就更简单，直接拿就是

请求参数如下

```python
param = {
    "id": uid,              # 要抓取的用户 uid
    "page": page,           # 当前页码，从 0 开始编号
    "guest": crawler.uid,   # 当前浏览者的 uid。如果不是看自己，悄悄话会抓不到
}
```

返回结构体大致如下

```python
ret = {
    'array': [
        {
            "time": "2013-08-20 15:21",     # 时间，格式 %Y-%m-%d %H:%M
            "guestId": guestId,             # 留言者 uid
            "guestName": guestName,         # 留言者用户名（留言时的）
            "tinyUrl": url,                 # 留言者的头像（留言时的）
            "headUrl": url,                 # 留言的附件缩略图（如果有）
            "largeUrl": url,                # 留言的附件大图
            "whisper": "true",              # 是否是悄悄话
            "wap": "true",                  # 是否是手机发布
            "gift": "true",                 # 是否赠送了礼物
            "giftImg": url,                 # 礼物图片地址
            "filteredBody": "blahblah"      # 表情转义后的正文
        }
    ]
}
```

有几个需要注意的地方

1. 留言板里每条留言的头像都是用户在留言当时的头像，而不是用户当前的头像，所以不好塞 `User` 表里，而是直接记录在留言里方便点
2. 时间给的字符串不是时间戳，自己用 `datetime.strptime` 转一下
3. 留言内容在好几个地方有，`filterOriginBody` 是最原始的，但是表情没转义，想拿转义后的在 `filterdBody` 或者 `body` 里，但是又加了很多没必要的东西，需要滤一下
4. 如果留言有附件，缩略图在 `headUrl`，大图在 `largeUrl`。这里吐槽下命名，难道不应该是头像用 `headUrl`，缩略图用 `tinyUrl` 么

> 2018-11-19 更新：抓非登陆者的留言板时可能遇上留言板是非公开的情况，导致抓不到数据，在 #22 里修复了这个问题


## 留言板内容过滤

`filterBody` 里有一些额外的信息需要过滤或转义，主要包括

1. 换行。把原始的 `\n` 转成 `<br>` 输出
2. 是否手机发布。这个过滤掉 `<xiaonei_wap/>` 就可以了，原始结构体里有是否手机发布的信息，注意要用字符串 `"true"` 和 `"false"` 而不是 Python 原生的 `True/False` 去判断
3. 是否是悄悄话。这个在原始结构体里有信息，过滤的时候把正文外面一大圈都去掉就好
4. 是否有赠送礼物。如果在原始结构体里有说明，则把 `<xiaonei_gift img="http://xxx" />` 的部分去掉

在过滤悄悄话的时候用了个正则去匹配，正文外面包了个 `<span style="color: #000">` 类似的写法，一开始自测时只发现黑色文本，后面有其他人来用的时候还发现了其他颜色，以及六位数的色值，把正则表达式升级一下就好了
